# TCP协议

- 面向连接
- 面向字节流
- 端到端通信
- 可靠传输服务 
- 全双工协议

## 报头结构

1. 源端口，目的端口：各16位
2. 序号（SEQ）：32位
3. 确认号（ACK）：32位
4. 数据偏移，保留字段，TCP标记，窗口大小
5. 校验和，紧急指针
6. 可选项，填充

前五项固定大小20字节，数据偏移的作用是定位数据部分起始位置，因为首部存在可选项导致长度不固定。

## 可靠传输的原理

### 停止等待协议

1. 停止等待：发送消息后，停止发送，等待接收方的确认。
2.  超时重传：接收方没有收到消息就不会发送确认，发送方一段时间后就会认为丢失，进而重传
   - 发送消息在路上丢失
   - 确认丢失
   - 确认消息很久才到
3. 每发送一个消息，就要设置一个定时器——**超时定时器**

**总结**：这是最简单的可靠传输协议，但是**信道利用率过低**，于是出现了连续ARQ协议

### 连续ARQ协议——批量的发送和确认

- 滑动窗口

- 累计确认：减少确认报文数量，提升网络效率

## TCP可靠传输——选择重传

指定需要重传的字节的边界，存放在报文头部的可选项中

## TCP流量控制

- 流量控制让发送方发送速率不要太快，以便接收方来得及接收
- 使用滑动窗口实现，接收方修改头部字段中的窗口字段，给出预期接收的数据多少

**坚持定时器**：当接收到窗口为0的消息时，发送方设置一个计时器，每隔一段时间发送一个探测报文询问对方窗口是否增大。其目的是防止接收方发来的关于窗口调整的报文丢失，造成死锁的局面。

## TCP拥塞控制

### 慢启动

- 由小到大增加发送量
- 收到报文确认，窗口值增加一倍，呈**指数增长**
- 到达阈值后执行拥塞避免

### 拥塞避免

- 维护一个拥塞窗口的变量
- 只要网络不拥塞，就试探着增加窗口大小，**线性增加**

### 快重传

当发送端收到连续三个相同的确认报文时，则认为网络出现拥塞，发送窗口乘法减小，慢启动阈值调整为当前阈值的二分之一。

**快在哪里**？如果接收端发送的确认丢失，发送端在超时重传定时器结束后才会进行重传。实际上接收到连续三个确认的时间间隔是更短的，所以更快

### 快恢复

发送窗口不会直接减小到0，而是减少一半，然后使用拥塞避免，窗口大小线性增加。

## 流量控制和拥塞控制的区别

- 流量控制负责端到端通信量的控制

- 拥塞控制考虑整个网络，是全局性的控制

## 三次握手

1. 第一次（SYN_SENT）：客户端发起请求，SYN=1，并携带一个随机序号seq作为初始序号。

2. 第二次（SYN_REVD）：服务端接收到请求，分配相应的内存和变量，并回应请求，SYN=1，seq随机，作为起始序号，ack=客户端序号加一，表示确认

3. 第三次（ESTABLISHED）：客户端收到连接确认，为连接分配内存和变量，并发送确认表示连接建立成功。ack等于服务器序号加一，表示确认。可以携带数据

### 为什么一定要三次？

- 大于三次可以，但没必要。

- 小于三次则可能引发错误。防止**已失效的连接请求报文**传送到对方，导致错误。

![失效连接报文造成的错误](/images/失效连接报文造成的错误.png)

## 四次挥手

1. 第一次（FIN_WAIT_1）：客户端发送请求，携带FIN，表示即将关闭连接了

2. 第二次（CLOSE_WAIT）：服务端发送一个确认，表示收到

3. 第三次（FIN_WAIT_2）：等待服务端发完数据，服务端发完数据后会发FIN来，发送后进入LAST_ACK状态

4. 第四次（CLOSED）：客户端收到后进入TIME_WAIT阶段，向服务器确认收到，并**等待一段时间**，如果该时间内服务端没有重发请求（重发请求是因为没有收到确认），则关闭。否则重新发送确认

**等待计时器**：等待时间为**2MSL(Max Segment Lifetime)**。MSL为最长报文段寿命，建议设置为2分钟

### 为什么需要等待？

- 最后一个报文没有确认
- 确保发送方的ACK能够到达对方
- 接收方在2MSL内没有收到确认，就会重发

 # UDP协议

报文结构：源端口，目的端口，报文长度，校验和，共8字节。其余部分为数据

特点：

- 无连接协议
- 不保证可靠交付，而是尽可能交付
- 面向报文。直接塞进数据部分，不会分段
- 没有拥塞控制

# TCP协议和UDP协议的区别

1. TCP协议是面向字节流的，UDP是面向报文的。
2. TCP是通过序号，确认号，超时重传，差错校验机制组成的可靠交付，UDP是尽可能交付。

3. TCP协议主要用于可靠信息服务（交易，可靠通讯等），UDP主要用于多媒体信息分发（视频，语音，实时信息）

