---
title: HTTPS加密过程
---

# 对称加密（相当于对暗号）

**加密和解密使用同一个密钥**。通信双方使用事先约定的密钥对会话内容进行加密和解密。中间人不知道密钥则无法获取内容。

问题：通信双方如何约定密钥，约定的密钥使用网络传输存在被窃取的风险，若密钥泄露，则失效。

 

# 非对称加密（RSA）

公钥加密内容只能使用私钥解密，私钥加密内容只能使用公钥解密。通信双方使用对方的公钥加密信息，对方使用自己的私钥解密即可

问题：速度太慢，可能存在中间人攻击

 

# 综合方案

使用对称加密算法进行加密，但传输密钥的过程使用非对称加密算法即可

 # 握手过程（TLS 1.2）

1. 客户端发起https请求，发送**随机数**、加密算法、协议版本。

2. 服务端确认协议版本，并生成一个**随机数**，连同自己的证书一起发送若协议版本不一致则关闭连接

3. 客户端收到证书，通过自己的根证书检查收到的证书是否有效，若有效则再生成一个**随机数**，并使用证书中包含的服务器公钥加密后回发，同时还会发送一个前面所有内容的hash值供服务端校验。否则提示风险

4. 服务器收到最后的这个随机数，一共三个随机数，通过计算生成最终的会话密钥。同时发送校验结果

至此，握手完成，之后的对话均使用该密钥加密

 

# 证书

通常会有一个受信任的第三方机构（CA）来颁发证书，将用户信息和公钥通过Hash算法生成一个摘要，使用CA的私钥对摘要进行加密生成数字签名，将数字签名和用户信息及公钥等信息合并，生成数字证书。接收端通过对用户信息进行同样Hash算法得到摘要，并使用CA的公钥解密后对比，两个摘要一致则信任。

 

# CA的公钥如何获取

操作系统／浏览器中会内置一些顶层的ＣA的证书，相当于你自动信任了他们。根证书告诉你哪些机构是可以信任的。

 

断开连接后如何恢复：

1. session ID：每一次会话都有一个编号，会话中断后再次连接需要客户端给出这个编号。服务器有这个记录则不用重新连接。此种方式对分布式集群不太友好
2. session ticket：只有服务器能解密，里面包含会话信息。是在上一次会话中发给用户的。

